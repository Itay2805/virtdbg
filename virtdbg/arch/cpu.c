#include "intrin.h"

#include "cpu.h"

void cpu_pause() {
    __builtin_ia32_pause();
}

void cpu_sleep() {
    asm ("hlt");
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Memory fences and barriers
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void memory_barrier() {
    asm ("" ::: "memory");
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Interrupt management
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void disable_interrupts() {
    asm volatile("cli" ::: "memory");
}

void enable_interrupts() {
    asm volatile("sti" ::: "memory");
}

bool are_interrupts_enabled() {
    ia32_rflags_t flags = { 0 };
    asm volatile (
        "pushfq\n"
        "pop %0"
        : "=r" (flags.raw)
    );
    return flags.IF == 1;
}
